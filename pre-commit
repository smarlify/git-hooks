#!/bin/sh
# .git/hooks/pre-commit
#
# This hook is executed before a commit is made.
# It runs TypeScript checking and linting, and auto-stages fixes.

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}ğŸ” Running pre-commit checks...${NC}"

# Check if we're in a TypeScript project
if [ -f "tsconfig.json" ] || [ -f "tsconfig.app.json" ] || [ -f "tsconfig.node.json" ]; then
    echo "${YELLOW}ğŸ“ Running TypeScript check...${NC}"

    # Run TypeScript check
    if command -v npx >/dev/null 2>&1; then
        # echo "${YELLOW}âš ï¸  TypeScript check temporarily disabled due to Node.js library issue${NC}"
        if npx tsc --noEmit; then
            echo "${GREEN}âœ… TypeScript check passed${NC}"
        else
            echo "${RED}âŒ TypeScript check failed${NC}"
            echo "${RED}Please fix TypeScript errors before committing.${NC}"
            exit 1
        fi
    else
        echo "${YELLOW}âš ï¸  npx not found, skipping TypeScript check${NC}"
    fi
fi

# Check if we have a linting script
if [ -f "package.json" ]; then
    # Check for common linting scripts
    if npm run lint --dry-run >/dev/null 2>&1; then
        echo "${YELLOW}ğŸ§¹ Running linter...${NC}"

        # Run linter
        if npm run lint; then
            echo "${GREEN}âœ… Linting passed${NC}"
        else
            echo "${RED}âŒ Linting failed${NC}"
            echo "${RED}Please fix linting errors before committing.${NC}"
            exit 1
        fi

        # Auto-stage any fixes made by the linter
        if [ -n "$(git diff --cached --name-only)" ]; then
            echo "${YELLOW}ğŸ“¦ Auto-staging linter fixes...${NC}"
            git add .
        fi
    else
        echo "${YELLOW}âš ï¸  No lint script found, skipping linting${NC}"
    fi

    # Check for build script
    # if npm run build --dry-run >/dev/null 2>&1; then
    #     echo "${YELLOW}ğŸ”¨ Running build check...${NC}"
    #
    #     # Run build to ensure everything compiles
    #     if npm run build; then
    #         echo "${GREEN}âœ… Build check passed${NC}"
    #     else
    #         echo "${RED}âŒ Build check failed${NC}"
    #         echo "${RED}Please fix build errors before committing.${NC}"
    #         exit 1
    #     fi
    # else
    #     echo "${YELLOW}âš ï¸  No build script found, skipping build check${NC}"
    # fi
fi

echo "${GREEN}ğŸ‰ All pre-commit checks passed!${NC}"
exit 0
