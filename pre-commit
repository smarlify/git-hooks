#!/bin/sh
# .git/hooks/pre-commit
#
# This hook is executed before a commit is made.
# It runs TypeScript checking and linting, and auto-stages fixes.

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}üîç Running pre-commit checks...${NC}"

# Check if we're in a TypeScript project
if [ -f "tsconfig.json" ] || [ -f "tsconfig.app.json" ] || [ -f "tsconfig.node.json" ]; then
    # Permanently skip TypeScript checks for games and git-hooks (known issues)
    REPO_NAME=$(basename "$(git rev-parse --show-toplevel)")
    if [ "$REPO_NAME" = "TrafficRun" ] || [ "$REPO_NAME" = "CrossyRoad" ] || [ "$REPO_NAME" = "SpaceShooter" ] || [ "$REPO_NAME" = "git-hooks" ]; then
        echo "${YELLOW}‚ö†Ô∏è  Skipping TypeScript check for $REPO_NAME (games/git-hooks - permanent skip)${NC}"
    else
        # Run TypeScript check
        if command -v npx >/dev/null 2>&1; then
            echo "${YELLOW}üìù Running TypeScript check...${NC}"
        
            # Run TypeScript check and capture output
            TSC_OUTPUT=$(npx tsc --noEmit 2>&1)
            TSC_EXIT_CODE=$?
            
            if [ $TSC_EXIT_CODE -eq 0 ]; then
                echo "${GREEN}‚úÖ TypeScript check passed${NC}"
            else
                echo "${RED}‚ùå TypeScript check failed${NC}"
                echo "${RED}TypeScript errors:${NC}"
                echo "$TSC_OUTPUT"
                echo "${RED}Please fix TypeScript errors before committing.${NC}"
                exit 1
            fi
        else
            echo "${YELLOW}‚ö†Ô∏è  npx not found, skipping TypeScript check${NC}"
        fi
    fi
fi

# Check if we have a linting script
if [ -f "package.json" ]; then
    # Permanently skip linting for games and git-hooks
    REPO_NAME=$(basename "$(git rev-parse --show-toplevel)")
    if [ "$REPO_NAME" = "TrafficRun" ] || [ "$REPO_NAME" = "CrossyRoad" ] || [ "$REPO_NAME" = "SpaceShooter" ] || [ "$REPO_NAME" = "git-hooks" ]; then
        echo "${YELLOW}‚ö†Ô∏è  Skipping linting for $REPO_NAME (games/git-hooks - permanent skip)${NC}"
    else
        # Check for common linting scripts
        if npm run lint --dry-run >/dev/null 2>&1; then
            echo "${YELLOW}üßπ Running linter...${NC}"

            # Run linter and capture output
            LINT_OUTPUT=$(npm run lint 2>&1)
            LINT_EXIT_CODE=$?

            if [ $LINT_EXIT_CODE -eq 0 ]; then
                echo "${GREEN}‚úÖ Linting passed${NC}"
                
                # Auto-stage any fixes made by the linter
                if [ -n "$(git diff --cached --name-only)" ]; then
                    echo "${YELLOW}üì¶ Auto-staging linter fixes...${NC}"
                    git add .
                fi
            else
                echo "${RED}‚ùå Linting failed${NC}"
                echo "${RED}Linting errors:${NC}"
                echo "$LINT_OUTPUT"
                echo "${RED}Please fix linting errors before committing.${NC}"
                exit 1
            fi
        else
            echo "${YELLOW}‚ö†Ô∏è  No lint script found, skipping linting${NC}"
        fi
    fi

    # SKIP: Check for build script
    # if npm run build --dry-run >/dev/null 2>&1; then
    #     echo "${YELLOW}üî® Running build check...${NC}"
    #
    #     # Run build to ensure everything compiles
    #     if npm run build; then
    #         echo "${GREEN}‚úÖ Build check passed${NC}"
    #     else
    #         echo "${RED}‚ùå Build check failed${NC}"
    #         echo "${RED}Please fix build errors before committing.${NC}"
    #         exit 1
    #     fi
    # else
    #     echo "${YELLOW}‚ö†Ô∏è  No build script found, skipping build check${NC}"
    # fi
fi

echo "${GREEN}üéâ All pre-commit checks passed!${NC}"
# GA HARD-CODE REMINDER
# Non-blocking notice: we hard-code GA gtag ID to avoid env drift breaking analytics
if git rev-parse --show-toplevel >/dev/null 2>&1; then
    REPO_ROOT=$(git rev-parse --show-toplevel)
    REPO_NAME=$(basename "$REPO_ROOT")
    # Only show for web apps likely to use GA
    if [ "$REPO_NAME" = "_DavidNekovar.cz" ] || [ -f "$REPO_ROOT/src/app/layout.tsx" ] || [ -f "$REPO_ROOT/src/index.html" ]; then
        # Check staged content for env-based GA usage
        if git diff --cached -U0 | grep -E "NEXT_PUBLIC_GA_ID|process\.env\.NEXT_PUBLIC_GA_ID" >/dev/null 2>&1; then
            echo "${YELLOW}‚ö†Ô∏è  GA NOTICE:${NC} Use a hard-coded GA4 Measurement ID (e.g., G-PVJHW3FCFK)."
            echo "${YELLOW}    Reason:${NC} Avoid env drift that can silently disable analytics."
        fi
    fi
fi
exit 0
